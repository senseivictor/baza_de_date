<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <title>Panou Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background-color: #f4f7f9;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #007bff;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      /* Navigatie Tab-uri */
      .nav-tabs {
        margin-bottom: 20px;
        display: flex;
        border-bottom: 2px solid #ced4da;
        flex-wrap: wrap;
      }

      .nav-tabs button {
        padding: 12px 20px;
        background: none;
        color: #495057;
        border: none;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        margin-right: 5px;
        font-size: 16px;
      }

      .nav-tabs button:hover {
        background-color: #e9ecef;
      }

      .nav-tabs button.active {
        background-color: #fff;
        color: #007bff;
        border: 1px solid #ced4da;
        border-bottom: 3px solid #fff;
        margin-bottom: -2px;
      }

      /* Stiluri Butoane */
      .action-button, .objective-button {
        padding: 10px 20px;
        margin: 10px 5px 10px 0;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        transition: transform 0.2s, background-color 0.2s;
      }

      .action-button:hover, .objective-button:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
      }

      .objective-button {
        width: 100%;
        text-align: left;
        background-color: #6c757d;
        margin-bottom: 5px;
      }
      
      .objective-button:hover {
        background-color: #5a6268;
      }

      .delete-button { background-color: #dc3545; }
      .delete-button:hover { background-color: #c82333; }

      /* Formulare & Inputs */
      .crud-form-section, .objective-content {
        border: 1px solid #ced4da;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #f8f9fa;
      }

      .objective-content {
        display: none; /* Ascuns implicit */
        background: #fff;
        border-left: 5px solid #007bff;
      }

      .form-row {
        display: flex;
        flex-wrap: wrap; 
        gap: 20px; 
        margin-bottom: 15px;
      }

      .form-group { flex: 1; min-width: 200px; margin-bottom: 10px; }
      .form-group label { display: block; font-weight: 600; margin-bottom: 5px; }
      input[type="text"], input[type="number"] {
          width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box;
      }

      pre {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 8px;
        white-space: pre-wrap;
        word-break: break-all;
        min-height: 50px;
        margin-top: 15px;
        font-family: monospace;
      }

      canvas {
        max-width: 100%;
        height: auto;
        margin-top: 20px;
        border: 1px solid #eee;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Panou de Administrare</h2>

      <div class="nav-tabs">
        <button class="tab-button active" onclick="switchView('general', this)">Analiză Generală</button>
        <button class="tab-button" onclick="switchView('crud', this)">Administrare Date (CRUD)</button>
        <button class="tab-button" onclick="switchView('objectives', this)">Obiective</button>
      </div>

      <!-- VIZUALIZARE 1: ANALIZĂ GENERALĂ -->
      <div id="generalView">
        <p>Vizualizare date agregate și statistici despre comenzi.</p>
        <button class="action-button" onclick="getLatestOrder()">Ultima comandă</button>
        <button class="action-button" onclick="getCompleted()">Comenzi finalizate</button>
        <button class="action-button" onclick="getPending()">Comenzi în așteptare</button>
        <button class="action-button" onclick="getWeeklyGraph()">Grafic ultimele 7 zile</button>
        
        <h3>Rezultat:</h3>
        <pre id="result">Apasă un buton pentru a vedea rezultatele.</pre>
        <div id="chartContainer" style="display: none; text-align:center;">
          <canvas id="ordersChart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <!-- VIZUALIZARE 2: CRUD OPERAȚII -->
      <div id="crudView" style="display: none;">
        <h3>Administrare Tabele</h3>
        <div style="margin-bottom: 20px;">
            <button class="action-button" onclick="showCrudTable('users_login_info')">Utilizatori</button>
            <button class="action-button" onclick="showCrudTable('products')">Produse</button>
            <button class="action-button" onclick="showCrudTable('orders')">Comenzi</button>
        </div>
        <div id="crudFormsContainer"></div>
        <h3>Log Operații:</h3>
        <pre id="crudResult"></pre>
      </div>

      <!-- VIZUALIZARE 3: OBIECTIVE -->
      <div id="objectivesView" style="display: none;">
        <h3>Obiective Specifice</h3>

        <!-- Obiectiv 1 -->
        <button class="objective-button" onclick="toggleObjective('obj1')">Obiectiv 1: Vizualizarea comenzilor unui utilizator specific</button>
        <div id="obj1" class="objective-content">
            <p>Introduceți ID-ul utilizatorului pentru a vedea istoricul comenzilor.</p>
            <div class="form-row">
                <input type="number" id="obj1-userId" placeholder="ID Utilizator (ex: 1)">
                <button class="action-button" onclick="runObjective1()">Caută Comenzi</button>
            </div>
            <pre id="obj1-result"></pre>
        </div>

        <!-- Obiectiv 2 -->
        <button class="objective-button" onclick="toggleObjective('obj2')">Obiectiv 2: Statistica comenzilor finalizate vs nefinisate</button>
        <div id="obj2" class="objective-content">
            <p>Afișează raportul între comenzile 'completed' și cele 'pending'.</p>
            <button class="action-button" onclick="runObjective2()">Generează Raport</button>
            <div style="text-align: center;">
                <canvas id="obj2-chart" width="400" height="400" style="display:none; margin: 0 auto;"></canvas>
            </div>
            <pre id="obj2-result"></pre>
        </div>

        <!-- Obiectiv 3 -->
        <button class="objective-button" onclick="toggleObjective('obj3')">Obiectiv 3: Statistica numărului zilnic de comenzi (Ultima săptămână)</button>
        <div id="obj3" class="objective-content">
            <p>Vizualizare grafică a volumului de comenzi pe zile.</p>
            <button class="action-button" onclick="runObjective3()">Afisează Grafic</button>
            <canvas id="obj3-chart" width="800" height="400" style="display:none;"></canvas>
        </div>

        <!-- Obiectiv 4 -->
        <button class="objective-button" onclick="toggleObjective('obj4')">Obiectiv 4: Statistica numărului nou de utilizatori (Ultima săptămână)</button>
        <div id="obj4" class="objective-content">
            <p>Câți utilizatori noi s-au înregistrat în ultimele 7 zile?</p>
            <button class="action-button" onclick="runObjective4()">Afisează Statistică</button>
            <canvas id="obj4-chart" width="800" height="400" style="display:none;"></canvas>
        </div>

        <!-- Obiectiv 5 -->
        <button class="objective-button" onclick="toggleObjective('obj5')">Obiectiv 5: Statistica comenzilor pe tipul de produse</button>
        <div id="obj5" class="objective-content">
            <p>Care sunt cele mai vândute produse?</p>
            <button class="action-button" onclick="runObjective5()">Analizează Produse</button>
            <div style="text-align: center;">
                <canvas id="obj5-chart" width="600" height="400" style="display:none; margin: 0 auto;"></canvas>
            </div>
            <pre id="obj5-result"></pre>
        </div>
      </div>
    </div>

    <script>
      const API = "http://localhost:8000";
      
      // --- NAVIGARE ---
      function switchView(viewName, btn) {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        ['generalView', 'crudView', 'objectivesView'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(viewName + 'View').style.display = 'block';
      }

      function toggleObjective(id) {
          const content = document.getElementById(id);
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
      }

      // --- FETCH HELPER ---
      async function fetchData(endpoint) {
          try {
              const res = await fetch(`${API}${endpoint}`);
              if (!res.ok) throw new Error(res.statusText);
              return await res.json();
          } catch (e) {
              alert("Eroare API: " + e.message);
              return null;
          }
      }

      // --- LOGICA OBIECTIVE ---

      // Obiectiv 1: User Orders
      async function runObjective1() {
          const userId = document.getElementById('obj1-userId').value;
          if(!userId) return alert("Introduceți ID utilizator");
          
          const data = await fetchData(`/get-orders?userId=${userId}`);
          document.getElementById('obj1-result').textContent = JSON.stringify(data, null, 2);
      }

      // Obiectiv 2: Status (Pie Chart)
      async function runObjective2() {
          const data = await fetchData(`/admin/stats/order-status`);
          if(data) {
              document.getElementById('obj2-result').textContent = JSON.stringify(data, null, 2);
              drawPieChart('obj2-chart', data);
          }
      }

      // Obiectiv 3: Comenzi Zilnice (Bar Chart)
      async function runObjective3() {
          const data = await fetchData(`/admin/orders-last-week`);
          if(data) {
              drawBarChart('obj3-chart', data.dates, data.counts, 'Comenzi');
          }
      }

      // Obiectiv 4: Utilizatori Noi (Bar Chart)
      async function runObjective4() {
          const data = await fetchData(`/admin/stats/new-users-last-week`);
          if(data) {
              drawBarChart('obj4-chart', data.dates, data.counts, 'Utilizatori Noi');
          }
      }

      // Obiectiv 5: Produse (Bar/Pie Chart)
      async function runObjective5() {
          const data = await fetchData(`/admin/stats/products-popularity`);
          if(data) {
              document.getElementById('obj5-result').textContent = JSON.stringify(data, null, 2);
              // Convertim obiectul in array-uri pentru bar chart
              const labels = Object.keys(data);
              const values = Object.values(data);
              drawBarChart('obj5-chart', labels, values, 'Vânzări', '#28a745');
          }
      }

      // --- FUNCTII GRAFICE (CANVAS) ---

      function drawBarChart(canvasId, labels, data, title, color = '#007bff') {
        const canvas = document.getElementById(canvasId);
        canvas.style.display = 'block';
        const ctx = canvas.getContext("2d");
        const W = canvas.width, H = canvas.height;
        const padding = 50;
        
        ctx.clearRect(0, 0, W, H);
        
        const maxVal = Math.max(...data, 1);
        const barWidth = (W - 2 * padding) / data.length * 0.6;
        const stepX = (W - 2 * padding) / data.length;

        // Axe
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, H - padding);
        ctx.lineTo(W - padding, H - padding);
        ctx.stroke();

        ctx.fillStyle = color;
        ctx.textAlign = "center";
        
        data.forEach((val, i) => {
            const h = (val / maxVal) * (H - 2 * padding);
            const x = padding + i * stepX + stepX/2 - barWidth/2;
            const y = H - padding - h;
            
            ctx.fillRect(x, y, barWidth, h);
            ctx.fillStyle = "#000";
            ctx.fillText(val, x + barWidth/2, y - 5);
            ctx.fillText(labels[i], x + barWidth/2, H - padding + 15);
            ctx.fillStyle = color;
        });
        
        ctx.font = "16px Arial";
        ctx.fillText(title, W/2, 20);
      }

      function drawPieChart(canvasId, dataObject) {
          const canvas = document.getElementById(canvasId);
          canvas.style.display = 'block';
          const ctx = canvas.getContext("2d");
          const W = canvas.width, H = canvas.height;
          const total = Object.values(dataObject).reduce((a, b) => a + b, 0);
          let startAngle = 0;
          const colors = ['#007bff', '#dc3545', '#ffc107', '#28a745', '#17a2b8'];
          
          ctx.clearRect(0, 0, W, H);
          const centerX = W / 2, centerY = H / 2, radius = 100;

          let i = 0;
          for (const [label, value] of Object.entries(dataObject)) {
              if (value === 0) continue;
              const sliceAngle = (value / total) * 2 * Math.PI;
              
              ctx.beginPath();
              ctx.moveTo(centerX, centerY);
              ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
              ctx.closePath();
              ctx.fillStyle = colors[i % colors.length];
              ctx.fill();
              
              // Legenda
              ctx.fillRect(W - 100, 50 + i * 20, 15, 15);
              ctx.fillStyle = "#000";
              ctx.fillText(`${label} (${value})`, W - 80, 62 + i * 20);

              startAngle += sliceAngle;
              i++;
          }
          
          if(total === 0) {
              ctx.fillText("Nu există date", centerX, centerY);
          }
      }

      // --- LOGICA GENERALA & CRUD (Existenta) ---
      // (Păstrată pentru funcționarea tab-urilor vechi)
      
      async function getLatestOrder() {
        const d = await fetchData("/admin/latest-order");
        document.getElementById("result").textContent = JSON.stringify(d, null, 2);
      }
      async function getCompleted() {
        const d = await fetchData("/admin/completed-orders");
        document.getElementById("result").textContent = JSON.stringify(d, null, 2);
      }
      async function getPending() {
        const d = await fetchData("/admin/pending-orders");
        document.getElementById("result").textContent = JSON.stringify(d, null, 2);
      }
      async function getWeeklyGraph() {
        const d = await fetchData("/admin/orders-last-week");
        document.getElementById("chartContainer").style.display = 'block';
        drawBarChart('ordersChart', d.dates, d.counts, 'Comenzi Saptamana');
      }

      function showCrudTable(table) {
          const container = document.getElementById('crudFormsContainer');
          container.innerHTML = '';
          const fields = getFields(table);
          
          ['add', 'update', 'delete'].forEach(action => {
              const html = createForm(table, fields, action);
              container.innerHTML += html;
          });
      }

      function getFields(table) {
          if(table === 'users_login_info') return ['user_id', 'name', 'created_at'];
          if(table === 'products') return ['product_id', 'name', 'price'];
          return ['order_id', 'order_public_id', 'user_id', 'products', 'order_status', 'created_at'];
      }

      function createForm(table, fields, action) {
        let html = `<div class="crud-form-section"><h4>${action.toUpperCase()} ${table}</h4>
        <form onsubmit="handleCrud(event, '${table}', '${action}')"><div class="form-row">`;
        
        if(action !== 'add') html += makeInput(fields[0], true); // PK
        
        if(action !== 'delete') {
            fields.forEach(f => {
                if((action === 'add' && f === fields[0]) || f === 'order_public_id' || f === 'created_at') return;
                html += makeInput(f, action === 'add');
            });
        }
        
        html += `</div><button class="action-button ${action === 'delete' ? 'delete-button' : ''}">${action}</button></form></div>`;
        return html;
      }

      function makeInput(name, required) {
          let ph = name;
          if(name === 'products') ph = 'JSON ex: [1, 2]';
          return `<div class="form-group"><label>${name}</label><input type="${name.includes('id') || name === 'price' ? 'number' : 'text'}" name="${name}" placeholder="${ph}" ${required ? 'required' : ''}></div>`;
      }

      async function handleCrud(e, table, action) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const payload = {};
          formData.forEach((v, k) => {
              if(v) payload[k] = (k.includes('id') || k === 'price') ? parseFloat(v) : v;
          });
          
          // Fix products for orders
          if(table === 'orders' && payload['products'] && typeof payload['products'] === 'string') {
               if(!payload['products'].startsWith('[')) {
                   payload['products'] = JSON.stringify(payload['products'].split(',').map(Number));
               }
          }

          const res = await fetch(`${API}/admin/crud/${table}/${action}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
          });
          const json = await res.json();
          document.getElementById('crudResult').textContent = JSON.stringify(json, null, 2);
          if(res.ok && action === 'add') e.target.reset();
      }
    </script>
  </body>
</html>