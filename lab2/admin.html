<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="UTF-8" />
    <title>Panou Admin DWH</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background-color: #f4f7f9;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      h2,
      h3 {
        color: #007bff;
      }
      h2 {
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      h3 {
        margin-top: 30px;
        color: #495057;
        font-size: 1.3em;
      }

      /* --- NAVIGARE TAB-URI --- */
      .nav-tabs {
        display: flex;
        border-bottom: 2px solid #ced4da;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .tab-button {
        padding: 12px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #495057;
        font-size: 16px;
        border-radius: 8px 8px 0 0;
        margin-right: 5px;
        transition: all 0.2s;
      }

      .tab-button:hover {
        background-color: #e9ecef;
      }

      .tab-button.active {
        background-color: #fff;
        color: #007bff;
        border: 1px solid #ced4da;
        border-bottom: 3px solid #fff;
        margin-bottom: -2px;
      }

      /* --- BUTOANE GENERALE --- */
      .action-button,
      .objective-button {
        padding: 10px 20px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        margin: 5px 5px 5px 0;
        transition: transform 0.2s, background-color 0.2s;
      }

      .action-button:hover,
      .objective-button:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
      }

      .delete-button {
        background-color: #dc3545;
      }
      .delete-button:hover {
        background-color: #c82333;
      }

      .objective-button {
        width: 100%;
        text-align: left;
        background-color: #6c757d;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .objective-button:after {
        content: "▼";
        font-size: 0.8em;
      }
      .objective-button.open:after {
        content: "▲";
      }

      /* --- CONTAINERE SI FORMULARE --- */
      .crud-form-section,
      .objective-content {
        border: 1px solid #ced4da;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #f8f9fa;
      }

      .crud-form-section h4 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px dashed #ced4da;
        color: #212529;
      }

      .objective-content {
        display: none;
        background: #fff;
        border-left: 5px solid #28a745; /* Green for Reports */
      }

      /* Layout Orizontal pentru Formulare (Flexbox) */
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
        align-items: flex-end;
      }

      .form-group {
        flex: 1;
        min-width: 200px;
        margin-bottom: 10px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 5px;
        color: #495057;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
      }

      /* Selector Data */
      .date-range-selector {
        display: flex;
        gap: 10px;
        align-items: center;
        background: #e9ecef;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        border: 1px solid #dee2e6;
      }

      .date-range-selector label {
        font-weight: bold;
        margin-right: 5px;
      }

      /* --- UTILITARE --- */
      pre {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 8px;
        white-space: pre-wrap;
        word-break: break-all;
        min-height: 50px;
        margin-top: 15px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 13px;
      }

      canvas {
        max-width: 100%;
        height: auto;
        margin-top: 20px;
        border: 1px solid #eee;
        background: #fff;
      }

      .warning-note {
        padding: 10px;
        margin-bottom: 15px;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .loading {
        text-align: center;
        color: #6c757d;
        padding: 20px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>Panou de Administrare DWH</h2>

      <!-- Navigare -->
      <div class="nav-tabs">
        <button class="tab-button active" onclick="switchView('crud', this)">
          Administrare Date (CRUD)
        </button>
        <button class="tab-button" onclick="switchView('reports', this)">
          Rapoarte DWH
        </button>
      </div>

      <!-- ========================================== -->
      <!-- TAB 1: CRUD (Create, Read, Update, Delete) -->
      <!-- ========================================== -->
      <div id="crudView">
        <h3>Selectează Tabela Dimensională/Fact:</h3>
        <div style="margin-bottom: 20px">
          <button class="action-button" onclick="showCrudTable('DimUser')">
            DimUser (Utilizatori)
          </button>
          <button class="action-button" onclick="showCrudTable('DimProduct')">
            DimProduct (Produse)
          </button>
          <button class="action-button" onclick="showCrudTable('DimOrder')">
            DimOrder (Comenzi)
          </button>
          <button class="action-button" onclick="showCrudTable('DimLocation')">
            DimLocation (Locații)
          </button>
          <button class="action-button" onclick="showCrudTable('DimStatus')">
            DimStatus (Statusuri)
          </button>
          <!-- NOU: Tabela Fact -->
          <button
            class="action-button"
            onclick="showCrudTable('FactOrderItems')"
          >
            FactOrderItems (Tranzacții)
          </button>
        </div>

        <div id="crudFormsContainer">
          <p style="color: #6c757d">
            Selectează o tabelă de mai sus pentru a afișa formularele de
            administrare.
          </p>
        </div>

        <h3>Jurnal Operații:</h3>
        <pre id="crudResult">Așteptare acțiuni...</pre>
      </div>

      <!-- ========================================== -->
      <!-- TAB 2: RAPOARTE DWH -->
      <!-- ========================================== -->
      <div id="reportsView" style="display: none">
        <h3>Rapoarte Agregate DWH</h3>

        <!-- Raport 1 -->
        <button
          class="objective-button"
          onclick="toggleObjective('rep1', this)"
        >
          1. Produsul cu cel mai mare și cel mai mic volum de vânzări
        </button>
        <div id="rep1" class="objective-content">
          <div class="date-range-selector">
            <label>Perioada (Opțional pentru Filtrare pe Timp):</label>
            <input type="date" id="start-rep1" />
            <span>până la</span>
            <input type="date" id="end-rep1" />
            <button class="action-button" onclick="runReport1()">
              Generează Raport
            </button>
          </div>
          <pre id="rep1-result"></pre>
        </div>

        <!-- Raport 2 -->
        <button
          class="objective-button"
          onclick="toggleObjective('rep2', this)"
        >
          2. Trimestrul cu cel mai mare profit total
        </button>
        <div id="rep2" class="objective-content">
          <div class="date-range-selector">
            <label>Perioada (Opțional pentru Filtrare pe Timp):</label>
            <input type="date" id="start-rep2" />
            <span>până la</span>
            <input type="date" id="end-rep2" />
            <button class="action-button" onclick="runReport2()">
              Generează Raport
            </button>
          </div>
          <pre id="rep2-result"></pre>
        </div>

        <!-- Raport 3 -->
        <button
          class="objective-button"
          onclick="toggleObjective('rep3', this)"
        >
          3. Top 10 Utilizatori după numărul de comenzi distincte
        </button>
        <div id="rep3" class="objective-content">
          <div class="date-range-selector">
            <label>Perioada (Opțional pentru Filtrare pe Timp):</label>
            <input type="date" id="start-rep3" />
            <span>până la</span>
            <input type="date" id="end-rep3" />
            <button class="action-button" onclick="runReport3()">
              Generează Raport
            </button>
          </div>
          <pre id="rep3-result"></pre>
        </div>

        <!-- Raport 4 -->
        <button
          class="objective-button"
          onclick="toggleObjective('rep4', this)"
        >
          4. Procentul mediu de discount (Weekend vs. Zile Săptămânale)
        </button>
        <div id="rep4" class="objective-content">
          <div class="date-range-selector">
            <label>Perioada (Opțional pentru Filtrare pe Timp):</label>
            <input type="date" id="start-rep4" />
            <span>până la</span>
            <input type="date" id="end-rep4" />
            <button class="action-button" onclick="runReport4()">
              Generează Raport & Grafic
            </button>
          </div>
          <div style="text-align: center">
            <canvas
              id="rep4-chart"
              width="400"
              height="400"
              style="display: none; margin: 0 auto"
            ></canvas>
          </div>
          <pre id="rep4-result"></pre>
        </div>

        <!-- Raport 5 -->
        <button
          class="objective-button"
          onclick="toggleObjective('rep5', this)"
        >
          5. Clasificarea Produselor după Volumul Total de Vânzări
        </button>
        <div id="rep5" class="objective-content">
          <div class="date-range-selector">
            <label>Perioada (Opțional pentru Filtrare pe Timp):</label>
            <input type="date" id="start-rep5" />
            <span>până la</span>
            <input type="date" id="end-rep5" />
            <button class="action-button" onclick="runReport5()">
              Generează Raport
            </button>
          </div>
          <pre id="rep5-result"></pre>
        </div>
      </div>
    </div>

    <script>
      const API = "http://localhost:8000";

      // ==========================================
      // UTILITARE GLOBALE
      // ==========================================

      // Setează datele implicite (Ultima săptămână)
      function setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date();
        lastWeek.setDate(today.getDate() - 7);

        const fmt = (d) => d.toISOString().split("T")[0];

        for (let i = 1; i <= 5; i++) {
          const startEl = document.getElementById(`start-rep${i}`);
          const endEl = document.getElementById(`end-rep${i}`);
          if (startEl && endEl) {
            startEl.value = fmt(lastWeek);
            endEl.value = fmt(today);
          }
        }
      }

      // Validare și conversie date în Timestamp UNIX
      function getTimestamps(repId) {
        const sVal = document.getElementById(`start-${repId}`).value;
        const eVal = document.getElementById(`end-${repId}`).value;

        if (!sVal || !eVal) {
          alert("Vă rugăm selectați ambele date (Început și Sfârșit)!");
          return null;
        }

        // Start: Ora 00:00:00
        const startTs = Math.floor(new Date(sVal).getTime() / 1000);
        // End: Ora 23:59:59 (+86399 secunde)
        const endTs = Math.floor(new Date(eVal).getTime() / 1000) + 86399;

        if (startTs > endTs) {
          alert("Data de început trebuie să fie anterioară datei de sfârșit.");
          return null;
        }
        return { start: startTs, end: endTs };
      }

      // Fetch Wrapper cu Error Handling
      async function fetchData(endpoint, resultElementId) {
        document.getElementById(resultElementId).textContent =
          "Se rulează raportul...";
        try {
          const url = endpoint.startsWith("http")
            ? endpoint
            : `${API}${endpoint}`;
          const res = await fetch(url);
          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(
              errData.detail || `HTTP ${res.status}: ${res.statusText}`
            );
          }
          const data = await res.json();
          document.getElementById(resultElementId).textContent = JSON.stringify(
            data,
            null,
            2
          );
          return data;
        } catch (e) {
          alert("Eroare API: " + e.message);
          console.error(e);
          document.getElementById(
            resultElementId
          ).textContent = `Eroare: ${e.message}`;
          return null;
        }
      }

      // Navigare Tab-uri
      function switchView(viewName, btn) {
        document
          .querySelectorAll(".tab-button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        ["crudView", "reportsView"].forEach((id) => {
          // Schimbat 'objectivesView' in 'reportsView'
          document.getElementById(id).style.display = "none";
        });
        document.getElementById(viewName + "View").style.display = "block";
      }

      // Acordion Obiective/Rapoarte
      function toggleObjective(id, btn) {
        const el = document.getElementById(id);
        const isOpen = el.style.display === "block";

        // Închide toate
        document
          .querySelectorAll(".objective-content")
          .forEach((d) => (d.style.display = "none"));
        document
          .querySelectorAll(".objective-button")
          .forEach((b) => b.classList.remove("open"));

        if (!isOpen) {
          el.style.display = "block";
          btn.classList.add("open");
        }
      }

      // ==========================================
      // LOGICA TAB 1: CRUD
      // ==========================================

      const CRUD_API = "/admin/crud";

      function getRomanianLabels(tableName, actionType) {
        const actions = {
          add: "Adaugă",
          update: "Actualizează",
          delete: "Șterge",
        };
        const tables = {
          DimUser: "Utilizator (DimUser)",
          DimProduct: "Produs (DimProduct)",
          DimOrder: "Comandă (DimOrder)",
          DimLocation: "Locație (DimLocation)",
          DimStatus: "Status (DimStatus)",
          FactOrderItems: "Tranzacție (FactOrderItems)", // Eticheta noua
        };
        return {
          actionLabel: actions[actionType] || actionType,
          tableLabel: tables[tableName] || tableName,
        };
      }

      function showCrudTable(tableName) {
        const container = document.getElementById("crudFormsContainer");
        container.innerHTML = "";
        document.getElementById(
          "crudResult"
        ).textContent = `Se lucrează pe tabela: ${tableName}`;

        // Câmpurile sunt preluate direct din cache
        const fields = showCrudTable.fieldsCache[tableName];

        // Generare 3 formulare: Add, Update, Delete
        container.innerHTML += createForm(tableName, fields, "add");
        container.innerHTML += createForm(tableName, fields, "update");
        container.innerHTML += createForm(tableName, fields, "delete");
      }

      function createForm(tableName, fields, actionType) {
        const formId = `${tableName}-${actionType}-form`;
        const labels = getRomanianLabels(tableName, actionType);

        let html = `<div class="crud-form-section"><h4>${labels.actionLabel} ${labels.tableLabel}</h4>`;

        // Notificări specifice tabelelor
        if (
          actionType === "add" &&
          tableName !== "DimLocation" &&
          tableName !== "DimProduct"
        ) {
          html += `<div class="warning-note"><strong>Notă:</strong> Câmpurile ID (PK/FK) necesită valori existente. Câmpurile IDENTITY (precum ${
            fields.find((f) => f.isIdentity)?.name || "N/A"
          }) vor fi ignorate la ADĂUGARE.</div>`;
        }
        if (tableName === "DimOrder" && actionType !== "delete") {
          html += `<div class="warning-note"><strong>DimOrder:</strong> 'products' trebuie să fie o listă de ID-uri separate prin virgulă (ex: 1, 2, 3) sau format JSON. 'user_id' și 'status_id' sunt FK-uri.</div>`;
        }
        if (tableName === "FactOrderItems" && actionType !== "delete") {
          html += `<div class="warning-note"><strong>FactOrderItems:</strong> Toate câmpurile ID (FK) trebuie să existe în tabelele dimensionale respective. 'sales_amount' și 'profit_margin' sunt obligatorii.</div>`;
        }

        html += `<form id="${formId}" onsubmit="handleCrudSubmit(event, '${tableName}', '${actionType}')"><div class="form-row">`;

        const pkField = fields.find((f) => f.isPK);

        // ID Input (obligatoriu pentru Update/Delete, opțional pentru Add dacă nu e Identity)
        if (pkField) {
          const isIdentity = pkField.isIdentity;
          const isRequired = actionType !== "add";

          if (isRequired || !isIdentity) {
            html += `<div class="form-group"><label>${pkField.name.toUpperCase()} (ID)</label>
                          <input type="number" name="${pkField.name}" ${
              isRequired ? "required" : ""
            } placeholder="${pkField.name}${
              isIdentity && actionType === "add" ? " (Ignorat)" : ""
            }"></div>`;
          }
        }

        // Restul câmpurilor
        if (actionType !== "delete") {
          fields.forEach((field) => {
            if (field.isPK && actionType !== "add") return; // PK handled above for update/delete
            if (field.isPK && field.isIdentity && actionType === "add") return; // Skip Identity PK on Add

            let type = "text";
            let placeholder = field.name;
            let required = "";
            let helpText = "";

            // Tipuri și Placeholdere/Required generice
            if (
              [
                "INT",
                "FLOAT",
                "DECIMAL",
                "TINYINT",
                "MONEY",
                "BIGINT",
              ].includes(field.type.toUpperCase())
            ) {
              type = "number";
            }
            if (field.name.includes("created_at")) {
              placeholder = "Unix Timestamp (Secunde)";
              required = actionType === "add" ? "required" : "";
            }
            if (field.name === "is_final") {
              placeholder = "1 (Final) sau 0 (Nu)";
              required = "required";
            }
            if (field.name === "products") {
              placeholder = "Ex: 1, 2, 3 sau [1, 2]";
            }

            // Required pentru câmpurile non-nullable/non-identity în ADD
            if (
              actionType === "add" &&
              !field.isNullable &&
              !field.isIdentity &&
              !field.isPK
            ) {
              required = "required";
            }

            // Configurare specifică FK FactOrderItems
            if (tableName === "FactOrderItems" && field.isFK) {
              const dimName = field.name.replace("_id", ""); // e.g., 'order' -> 'DimOrder'
              helpText = ` (FK Dim${
                dimName.charAt(0).toUpperCase() + dimName.slice(1)
              })`;
            }

            // Configurare specifică Măsuri FactOrderItems
            if (tableName === "FactOrderItems") {
              if (field.name === "profit_margin") {
                placeholder = "Ex: 0.15 (Procent zecimal)";
              } else if (field.name === "sales_amount") {
                placeholder = "Valoare totală vânzare";
                required = "required";
              }
            }

            html += `<div class="form-group"><label>${
              field.name
            }${helpText}</label>
                           <input type="${type}" name="${
              field.name
            }" placeholder="${placeholder}" ${required} 
                           ${
                             actionType === "update" &&
                             field.name === "order_public_id"
                               ? "readonly"
                               : ""
                           } ></div>`;
          });
        }

        const btnClass = actionType === "delete" ? "delete-button" : "";
        html += `</div><button type="submit" class="action-button ${btnClass}">${labels.actionLabel}</button></form></div>`;
        return html;
      }

      async function handleCrudSubmit(e, tableName, actionType) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const payload = {};

        for (const [key, value] of formData.entries()) {
          const val = value.trim();
          if (val === "") continue;

          // Conversie tipuri DWH
          const field = showCrudTable.fieldsCache[tableName].find(
            (f) => f.name === key
          );
          const fieldType = field ? field.type.toUpperCase() : "";

          if (key === "products") {
            // Converteste "1, 2, 3" -> "[1, 2, 3]" daca nu e deja JSON
            if (!val.startsWith("[") && !val.endsWith("]")) {
              const arr = val
                .split(",")
                .map((s) => Number(s.trim()))
                .filter((n) => !isNaN(n) && n > 0);
              payload[key] = JSON.stringify(arr);
            } else {
              payload[key] = val; // Presupunem ca e deja JSON valid
            }
          } else if (
            ["INT", "FLOAT", "DECIMAL", "TINYINT", "MONEY", "BIGINT"].includes(
              fieldType
            ) ||
            key.includes("id") ||
            key.includes("created_at") ||
            key === "price"
          ) {
            const num = parseFloat(val);
            payload[key] = isNaN(num) ? val : num;
          } else {
            payload[key] = val;
          }
        }

        document.getElementById(
          "crudResult"
        ).textContent = `Se trimite cererea ${actionType.toUpperCase()} pe ${tableName}...`;

        try {
          const res = await fetch(
            `${API}${CRUD_API}/${tableName}/${actionType}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          const json = await res.json();

          if (res.ok) {
            document.getElementById(
              "crudResult"
            ).textContent = `Succes:\n${JSON.stringify(json, null, 2)}`;
            if (actionType === "add") e.target.reset();
          } else {
            document.getElementById(
              "crudResult"
            ).textContent = `Eroare:\n${JSON.stringify(json, null, 2)}`;
          }
        } catch (err) {
          document.getElementById("crudResult").textContent =
            "Eroare rețea: " + err.message;
        }
      }

      // Cache-ul de câmpuri pentru a fi accesibil în handleCrudSubmit
      showCrudTable.fieldsCache = {
        DimUser: [
          { name: "user_id", type: "INT", isPK: true, isIdentity: true },
          { name: "nume", type: "VARCHAR" },
          { name: "created_at", type: "INT" },
          { name: "location_id", type: "INT" },
        ],
        DimProduct: [
          { name: "product_id", type: "INT", isPK: true },
          { name: "name", type: "VARCHAR" },
          { name: "price", type: "FLOAT" },
        ],
        DimOrder: [
          { name: "order_id", type: "INT", isPK: true, isIdentity: true },
          { name: "order_public_id", type: "VARCHAR" },
          { name: "user_id", type: "INT" },
          { name: "products", type: "VARCHAR" },
          { name: "order_status", type: "VARCHAR" },
          { name: "created_at", type: "INT" },
          { name: "status_id", type: "INT" },
          { name: "created_time_id", type: "INT" },
        ],
        DimLocation: [
          { name: "location_id", type: "INT", isPK: true },
          { name: "country", type: "VARCHAR" },
          { name: "region", type: "VARCHAR" },
        ],
        DimStatus: [
          { name: "status_id", type: "INT", isPK: true, isIdentity: true },
          { name: "status_name", type: "VARCHAR" },
          { name: "is_final", type: "TINYINT" },
        ],
        // INCLUZĂND FactOrderItems
        FactOrderItems: [
          { name: "fact_id", type: "BIGINT", isPK: true, isIdentity: true },
          { name: "order_id", type: "INT", isFK: true, isNullable: false },
          { name: "user_id", type: "INT", isFK: true, isNullable: false },
          { name: "product_id", type: "INT", isFK: true, isNullable: false },
          { name: "time_id", type: "INT", isFK: true, isNullable: false },
          { name: "status_id", type: "INT", isFK: true, isNullable: false },
          { name: "location_id", type: "INT", isFK: true, isNullable: false },
          { name: "sales_amount", type: "MONEY", isNullable: false },
          { name: "profit_margin", type: "FLOAT", isNullable: false },
          { name: "discount_amount", type: "MONEY", isNullable: true },
        ],
      };

      // ==========================================
      // LOGICA TAB 2: RAPOARTE DWH (runReportX)
      // ==========================================

      // 1. Produsul cu cel mai mare și cel mai mic volum de vânzări
      async function runReport1() {
        const ts = getTimestamps("rep1");
        if (!ts) return;
        await fetchData(
          `/admin/reports/top-low-sales?start=${ts.start}&end=${ts.end}`,
          "rep1-result"
        );
      }

      // 2. Trimestrul cu cel mai mare profit total
      async function runReport2() {
        const ts = getTimestamps("rep2");
        if (!ts) return;
        await fetchData(
          `/admin/reports/top-quarter-profit?start=${ts.start}&end=${ts.end}`,
          "rep2-result"
        );
      }

      // 3. Top 10 Utilizatori după numărul de comenzi distincte
      async function runReport3() {
        const ts = getTimestamps("rep3");
        if (!ts) return;
        await fetchData(
          `/admin/reports/top-10-users-orders?start=${ts.start}&end=${ts.end}`,
          "rep3-result"
        );
      }

      // 4. Procentul mediu de discount (Weekend vs. Zile Săptămânale)
      async function runReport4() {
        const ts = getTimestamps("rep4");
        if (!ts) return;
        const data = await fetchData(
          `/admin/reports/avg-discount-weekend-vs-weekday?start=${ts.start}&end=${ts.end}`,
          "rep4-result"
        );

        if (data && Array.isArray(data) && data.length > 0) {
          // Datele sunt in format [{Perioada: 'Weekend', Procent_Mediu_Discount: X}, ...]
          const labels = data.map((item) => item.Perioada);
          // Scalăm procentul cu 100 pentru a-l afișa ca număr întreg vizibil pe grafic
          const values = data.map((item) =>
            Math.round(item.Procent_Mediu_Discount)
          );
          drawPieChart(
            "rep4-chart",
            {
              [labels[0]]: values[0],
              [labels[1]]: values[1],
            },
            "Procent Mediu Discount (%)"
          );
        } else {
          document.getElementById("rep4-chart").style.display = "none";
        }
      }

      // 5. Clasificarea Produselor după Volumul Total de Vânzări
      async function runReport5() {
        const ts = getTimestamps("rep5");
        if (!ts) return;
        await fetchData(
          `/admin/reports/product-sales-classification?start=${ts.start}&end=${ts.end}`,
          "rep5-result"
        );
      }

      // ==========================================
      // FUNCTII DESENARE CANVAS (Păstrate de la cererea anterioară)
      // ==========================================

      function drawBarChart(id, labels, data, title, color = "#007bff") {
        const cvs = document.getElementById(id);
        cvs.style.display = "block";
        // Setăm lățimea și înălțimea vizibilă a canvas-ului
        const chartW = cvs.clientWidth;
        cvs.width = chartW;
        cvs.height = 500; // Înălțimea mărită, conform cererii anterioare

        const ctx = cvs.getContext("2d");
        const W = cvs.width,
          H = cvs.height;
        // Padding de jos mărit pentru etichetele rotite
        const pTop = 50,
          pLeft = 50,
          pRight = 20,
          pBottom = 100;

        ctx.clearRect(0, 0, W, H);

        // Verifică date
        const maxVal = Math.max(...data, 1);
        if (data.length === 0) {
          ctx.textAlign = "center";
          ctx.fillText("Nu există date în perioada selectată", W / 2, H / 2);
          return;
        }

        const usableW = W - pLeft - pRight;
        const usableH = H - pTop - pBottom;

        const barW = (usableW / data.length) * 0.6;
        const step = usableW / data.length;

        // Axe
        ctx.strokeStyle = "#999";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(pLeft, pTop);
        ctx.lineTo(pLeft, H - pBottom);
        ctx.lineTo(W - pRight, H - pBottom);
        ctx.stroke();
        ctx.lineWidth = 1;

        // Etichete Axa Y (simpla)
        ctx.fillStyle = "#333";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "right";
        ctx.fillText(maxVal, pLeft - 5, pTop + 5);
        ctx.fillText("0", pLeft - 5, H - pBottom + 5);

        // Calcul pas afișare etichete (pentru a nu aglomera axa X)
        const maxLabels = 12; // Maxim 12 etichete pe axă
        const labelSkip = Math.ceil(labels.length / maxLabels);

        ctx.fillStyle = color;
        ctx.textAlign = "center";
        data.forEach((val, i) => {
          const h = (val / maxVal) * usableH;
          const x = pLeft + i * step + step / 2 - barW / 2;
          const y = H - pBottom - h;

          // Bara
          ctx.fillRect(x, y, barW, h);

          // Valoarea deasupra
          ctx.fillStyle = "#000";
          ctx.fillText(val, x + barW / 2, y - 5);

          // Eticheta jos (rotita)
          if (i % labelSkip === 0) {
            ctx.save();
            ctx.translate(x + barW / 2, H - pBottom + 5);
            ctx.rotate(Math.PI / 4); // 45 grade
            ctx.textAlign = "left";

            ctx.fillStyle = "#333";
            ctx.fillText(labels[i], 0, 0);
            ctx.restore();
          }

          ctx.fillStyle = color; // Resetare culoare pentru următoarea bară
        });

        // Titlu
        ctx.fillStyle = "#333";
        ctx.font = "bold 18px sans-serif";
        ctx.fillText(title, W / 2, 25);
      }

      function drawPieChart(id, dataObj, title = "Distributie") {
        const cvs = document.getElementById(id);
        cvs.style.display = "block";
        const ctx = cvs.getContext("2d");
        const W = cvs.width,
          H = cvs.height;
        ctx.clearRect(0, 0, W, H);

        const total = Object.values(dataObj).reduce((a, b) => a + b, 0);
        if (total === 0) {
          ctx.fillStyle = "#333";
          ctx.textAlign = "center";
          ctx.fillText("Fără date în perioada selectată", W / 2, H / 2);
          return;
        }

        let start = 0;
        const colors = [
          "#007bff",
          "#28a745",
          "#ffc107",
          "#dc3545",
          "#17a2b8",
          "#6610f2",
        ];
        let i = 0;

        Object.entries(dataObj).forEach(([lbl, val]) => {
          const slice = (val / total) * 2 * Math.PI;

          // Felie
          ctx.beginPath();
          ctx.moveTo(W / 2, H / 2);
          ctx.arc(W / 2, H / 2, 100, start, start + slice);
          ctx.fillStyle = colors[i % colors.length];
          ctx.fill();

          // Legenda
          ctx.fillRect(W - 130, 50 + i * 25, 15, 15);
          ctx.fillStyle = "#333";
          ctx.textAlign = "left";
          ctx.fillText(
            `${lbl}: ${val}${title.includes("%") ? "%" : ""} (${Math.round(
              (val / total) * 100
            )}%)`,
            W - 110,
            62 + i * 25
          );

          start += slice;
          i++;
        });

        // Titlu
        ctx.fillStyle = "#333";
        ctx.font = "bold 16px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(title, W / 2, 25);
      }

      // Inițializare la încărcare
      document.addEventListener("DOMContentLoaded", () => {
        setDefaultDates();
        // Selectează implicit primul tab
        switchView("crud", document.querySelector(".tab-button.active"));
      });
    </script>
  </body>
</html>
